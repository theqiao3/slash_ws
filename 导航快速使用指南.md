# Slash 机器人导航快速使用指南

## 前置条件检查

### 1. 硬件连接
- ✅ Livox激光雷达已连接并上电
- ✅ IMU正常工作
- ✅ VESC电机驱动已连接
- ✅ 机器人底盘可以正常移动

### 2. 软件依赖
```bash
# 安装必要的依赖
sudo apt install ros-$ROS_DISTRO-nav2-bringup \
                 ros-$ROS_DISTRO-navigation2 \
                 ros-$ROS_DISTRO-slam-toolbox \
                 python3-scipy \
                 python3-open3d

# 或者使用pip安装open3d（如果apt安装失败）
pip3 install open3d scipy
```

## 第一步：地图转换

### 将FAST_LIO生成的PCD地图转换为2D栅格地图

```bash
# 进入工作空间
cd ~/slash_ws

# 给脚本添加执行权限
chmod +x src/slash_navigation/slash_nav2/scripts/pcd_to_pgm.py

# 转换地图（使用已有的PCD文件）
python3 src/slash_navigation/slash_nav2/scripts/pcd_to_pgm.py \
    src/slash_navigation/slash_nav2/PCD/RMUC.pcd \
    src/slash_navigation/slash_nav2/map/RMUC_from_pcd \
    --resolution 0.05 \
    --height-min 0.1 \
    --height-max 2.0

# 参数说明：
# - 输入文件: src/slash_navigation/slash_nav2/PCD/RMUC.pcd
# - 输出文件: src/slash_navigation/slash_nav2/map/RMUC_from_pcd (会生成.pgm和.yaml)
# - resolution: 地图分辨率，0.05米/像素
# - height-min: 只考虑高度>0.1米的点（过滤地面）
# - height-max: 只考虑高度<2.0米的点（过滤天花板）
```

**查看转换结果：**
```bash
# 生成的文件
ls -lh src/slash_navigation/slash_nav2/map/RMUC_from_pcd*

# 应该看到：
# - RMUC_from_pcd.pgm  (地图图像)
# - RMUC_from_pcd.yaml (地图配置)
```

## 第二步：编译工作空间

```bash
cd ~/slash_ws

# 编译（如果之前已编译，可以只编译修改的包）
colcon build --symlink-install --packages-select slash_nav2 twist_to_ackermann

# 如果需要完整编译
# colcon build --symlink-install

# 加载环境变量
source install/setup.bash
```

## 第三步：启动导航系统

### 方法A：使用完整启动文件（推荐）

```bash
cd ~/slash_ws
source install/setup.bash

# 启动完整导航系统
ros2 launch slash_nav2 navigation_full.launch.py \
    map:=$(pwd)/src/slash_navigation/slash_nav2/map/RMUC_from_pcd.yaml
```

这个命令会启动：
1. FAST_LIO（定位和里程计）
2. 地面分割节点
3. Nav2导航栈（包括AMCL、规划器、控制器等）
4. Twist到Ackermann转换节点
5. RViz可视化

### 方法B：分步启动（用于调试）

**终端1：启动FAST_LIO**
```bash
cd ~/slash_ws
source install/setup.bash
ros2 launch fast_lio mapping.launch.py
```

**终端2：启动地面分割**
```bash
cd ~/slash_ws
source install/setup.bash
ros2 launch linefit_ground_segmentation_ros segmentation.launch.py

ros2 launch pointcloud_to_laserscan pointcloud_to_laserscan_launch.py
```

**终端3：启动Nav2导航**
```bash
cd ~/slash_ws
source install/setup.bash
ros2 launch slash_nav2 bringup_real.launch.py \
    map:=/home/tianbot/slash_ws/src/slash_navigation/slash_nav2/map/test.yaml
```

**终端4：启动速度转换**
```bash
cd ~/slash_ws
source install/setup.bash
ros2 run twist_to_ackermann twist_to_ackermann_node
```

## 第四步：在RViz中设置初始位姿和导航目标

### 1. 设置初始位姿（2D Pose Estimate）
1. 在RViz顶部工具栏找到 "2D Pose Estimate" 按钮
2. 点击按钮，然后在地图上点击机器人当前的**大致位置**
3. 按住鼠标并拖动，设置机器人的**朝向**
4. 松开鼠标

观察：
- 粒子云应该在机器人周围聚集
- 激光扫描数据应该与地图对齐

**如果位姿不准确：**
- 多次设置初始位姿，直到激光数据与地图对齐
- 或者慢慢移动机器人，让AMCL自动收敛

### 2. 发送导航目标（2D Nav Goal）
1. 在RViz顶部工具栏找到 "2D Nav Goal" 按钮
2. 点击按钮，然后在地图上点击**目标位置**
3. 按住鼠标并拖动，设置**目标朝向**
4. 松开鼠标

观察：
- 全局路径（绿色）应该出现
- 局部路径（红色）应该出现
- 机器人开始移动

## 第五步：监控和调试

### 查看话题列表
```bash
# 查看所有话题
ros2 topic list

# 关键话题：
# /Odometry              - FAST_LIO输出的里程计
# /cmd_vel               - Nav2输出的速度指令
# /drive                 - 转换后的阿克曼驱动指令
# /scan                  - 激光扫描数据（如果有）
# /segmentation/obstacle - 障碍物点云
# /tf                    - TF变换
```

### 检查TF树
```bash
# 安装TF工具
sudo apt install ros-$ROS_DISTRO-tf2-tools

# 查看TF树
ros2 run tf2_tools view_frames

# 会生成frames.pdf文件，使用PDF查看器打开
evince frames.pdf

# 应该看到完整的TF树：
# map -> odom -> base_link -> lidar_link
```

### 监控特定话题
```bash
# 查看里程计
ros2 topic echo /Odometry --once

# 查看速度指令
ros2 topic echo /cmd_vel

# 查看驱动指令
ros2 topic echo /drive

# 查看TF
ros2 run tf2_ros tf2_echo map base_link
```

### 查看日志
```bash
# 实时查看所有日志
ros2 run rqt_console rqt_console

# 或者在终端查看特定节点的日志
ros2 node list  # 列出所有节点
ros2 topic echo /rosout | grep "节点名称"
```

## 常见问题排查

### 问题1：机器人不移动
**检查清单：**
```bash
# 1. 检查是否收到速度指令
ros2 topic hz /cmd_vel
ros2 topic echo /cmd_vel

# 2. 检查速度转换是否工作
ros2 topic hz /drive
ros2 topic echo /drive

# 3. 检查VESC驱动是否运行
ros2 node list | grep vesc

# 4. 检查是否有错误日志
ros2 run rqt_console rqt_console
```

### 问题2：定位不准确
**检查清单：**
```bash
# 1. 检查AMCL是否收到激光数据
ros2 topic hz /scan

# 2. 查看粒子分布
# 在RViz中添加ParticleCloud显示，话题：/particle_cloud

# 3. 检查TF树
ros2 run tf2_tools view_frames

# 4. 调整AMCL参数
# 编辑：src/slash_navigation/slash_nav2/config/nav2_params.yaml
# 增加粒子数：max_particles: 5000
```

### 问题3：路径规划失败
**检查清单：**
```bash
# 1. 检查地图是否正确加载
ros2 topic echo /map --once

# 2. 查看代价地图
# 在RViz中添加Map显示
# - 话题：/global_costmap/costmap
# - 话题：/local_costmap/costmap

# 3. 检查目标是否可达
# - 目标点是否在障碍物上？
# - 目标点是否太远？
# - 路径是否被障碍物完全阻挡？

# 4. 查看规划器日志
ros2 topic echo /rosout | grep planner
```

### 问题4：地图与实际环境不匹配
**解决方案：**
```bash
# 方法1：调整地图转换参数
python3 src/slash_navigation/slash_nav2/scripts/pcd_to_pgm.py \
    src/slash_navigation/slash_nav2/PCD/RMUC.pcd \
    src/slash_navigation/slash_nav2/map/RMUC_adjusted \
    --resolution 0.03 \
    --height-min 0.05 \
    --height-max 1.5

# 方法2：重新建图
# 使用FAST_LIO重新建图，确保扫描更完整

# 方法3：使用2D SLAM建图
# 安装slam_toolbox并使用2D激光雷达建图
```

## 参数调优

### 调整机器人物理参数
编辑：`src/slash_navigation/slash_nav2/config/nav2_params.yaml`

```yaml
# 找到以下参数并根据实际机器人调整：

# 机器人半径（米）
robot_radius: 0.385  # 修改为实际值

# 阿克曼参数
wheelbase: 0.4            # 前后轮轴距
min_turning_radius: 0.85  # 最小转弯半径

# 速度限制
max_vel_x: 1.5            # 最大前进速度
max_vel_x_backwards: 0.5  # 最大后退速度
max_vel_theta: 1.5        # 最大角速度
```

### 调整导航行为
```yaml
# 速度平滑器
velocity_smoother:
  max_velocity: [2.0, 0.0, 0.5]  # [前进, 横向, 旋转]
  max_accel: [0.5, 0.0, 0.4]     # 加速度限制

# TEB规划器
FollowPath:
  max_vel_x: 1.5           # 降低以提高稳定性
  min_obstacle_dist: 0.3   # 增加以保持更大安全距离
```

## 下一步

1. **测试基本导航**：在已知环境中测试点对点导航
2. **记录参数**：记录最佳参数配置
3. **压力测试**：测试动态障碍物避障
4. **性能优化**：根据实际表现调整参数
5. **添加功能**：考虑添加waypoint导航、返航等功能

## 参考资料

- Nav2文档：https://navigation.ros.org/
- FAST-LIO：https://github.com/hku-mars/FAST_LIO
- TEB Local Planner：http://wiki.ros.org/teb_local_planner

## 技术支持

如有问题，请检查：
1. 终端输出的错误信息
2. RViz中的可视化是否正常
3. TF树是否完整
4. 各个话题是否有数据发布

保存重要的日志信息用于调试：
```bash
# 保存所有话题列表
ros2 topic list > topics.txt

# 保存TF树
ros2 run tf2_tools view_frames
cp frames.pdf debug_frames.pdf

# 保存节点信息
ros2 node list > nodes.txt
```
